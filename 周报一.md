# 周报一

# UDP

- 协议开销小、效率高。
- UDP是无连接的，即发送数据之前不需要建立连接。
- UDP使用尽最大努力交付，即不保证可靠交付。
- UDP没有拥塞控制。
- UDP支持一对一、一对多、多对一和多对多交互通信。
- UDP的首部开销小，只有8个字节。

# TCP

Transmission Control Protocol传输控制协议

**TCP**是一种面向连接的、可靠的、基于字节流的传输层协议，确保数据从发送端到接收端能够完整、有序并且无误地传输。TCP协议通过流量控制、拥塞控制以及重传机制来保证数据的可靠性。

## 三次握手

![image-20251112092247678](D:\PROJECT\MDProject\CS\网络.assets\image-20251112092247678.png)

建立连接的过程称为三次握手Three-Way Handshake,需要客户端和服务端总共发送3个包，目的是确保双方都能准备好进行数据传输

- 客户端发起连接（SYN=1）：客户端将SYN置1，随机产生值seq=s，将数据包发送给服务端，客户端进入SYN_SENT状态，等待服务端确认
- 服务器确认连接请求（SYN-ACK）：服务器收到数据包后由SYN=1知道客户端请求建立连接，服务端将SYN和ACK标志位都置1，ack=s+1（值），随机产生seq=k,并将该数据包发送给客户端以确认连接请求，服务端进入SYN_RCVD状态
- 客户端确认连接（ACK）：客户端收确认后，检查ack值是否为s+1,ACK标志位是否置1，是则将标志位ACK置1，ack=k+1,并将数据包发送给服务端，服务端检查ack值是否为k+1,ACK标志位是否置1，正确则成功建立连接，客户端和服务端进入ESTABLISHED状态

## 四次挥手

当一个连接不再需要时，TCP通过四次挥手Connection Termination终止连接，确保数据完整性

- 客户端发起连接关闭（FIN）：客户端发送一个FIN（结束）包，进入FIN_WAIT_1状态
- 服务器确认关闭请求（ACK）：服务器收到FIN包后，向客户端发送一个ACK包，确认序号为收到序号+1，服务端进入CLOSE_WAIT状态
- **服务器发送关闭请求**（FIN）：服务器向客户端发送一个FIN包，用来关闭数据传送，服务端进入LAST_ACK状态
- **客户端确认关闭**（ACK）：客户端收到FIN包后，进入TIME_WAIT状态，接着发送ACK包确认序号为收到序号+1，服务端进入CLOSED状态，连接彻底断开。

## 拥塞控制

拥塞是指网络中报文数量过多，使得服务端来不及处理，以致引起这部分乃至整个网络性能下降的现象，严重时甚至会导致网络通信业务陷入停顿即出现死锁现象。

TCP采用拥塞控制算法来减少或者避免拥塞现象的发生，TCP的拥塞算法有过多种实现，包括Tahoe、Reno、NewReno、Vegas、Hybla、BIC 、CUBIC、SACK、Westwood、PRR、BBR等。

## **TCP的头部结构**

TCP头部包含了许多信息，用于数据传输和控制：

- **源端口**：发送端应用程序的端口号
- **目标端口**：接收端应用程序的端口号
- **序列号**：用于保证数据的顺序
- **确认号**：用于确认收到的数据
- **标志位**：如SYN、ACK、FIN等，用于控制连接
- **窗口大小**：用于流量控制，指示接收方能够接受多少字节的数据
- **校验和**：用于检测数据是否在传输过程中被篡改
- **紧急指针**：如果URG标志位设置为1，则指示数据中紧急部分的结尾

**TCP的重传机制**

- **超时重传**：发送方发送数据后等待接收方的确认。如果在规定时间内未收到确认，则认为数据丢失，需要重新发送。
- **快速重传**：如果发送方收到接收方的重复确认号（表示丢失的包），则会立即重新发送丢失的数据包，而不是等待超时。

# DNS

https://www.freebuf.com/articles/web/419519.html

Domain Name System域名解析系统，域名解析是将域名转换为IP地址的过程，从而与服务器建立通信。DNS使用TCP和UDP协议的53端口

难以记忆的IP转换为人类可读的Domain Name，从右向左读依次是顶级域名TLD(Top-Level Domain),二级域名SLD,子域名Subdomain

https://developer.mozilla.org/zh-CN/docs/Learn_web_development/Howto/Web_mechanics/What_is_a_domain_name

## 查询

**WHOIS 查询**

```
whois example.com
```

- 输出包括注册者、注册商、域名创建时间、到期时间、DNS服务器等信息
- https://whois.com/whois/example.com
- https://whois.domaintools.com/

**DNS查询**

查询域名的DNS记录：

- A记录，返回域名的IPv4地址
- MX记录，电子邮件交换记录，记录邮件域名对应的IP地址
- NS记录，域名服务器，返回该域名由哪台域名服务器解析
- PTR记录，反向记录，从IP地址到域名的记录

https://www.cnblogs.com/bluestorm/p/10345334.html

```
dig example.com
nslookup example.com
```

- https://mxtoolbox.com/
- https://www.dnsstuff.com/

**子域名枚举**

```
python sublist3r.py -d example.com
subfinder -d example.com
```

**暴力破解**：发现未知的子域名或路径

```
ffuf -w /path/to/wordlist.txt -u https://example.com/FUZZ
```

用字典wordlist暴力猜测example.com的URL路径

```
dnsenum example.com
```

枚举DNS记录，并暴力查找子域名

**SSL/TLS证书信息查询**

```
sslyze --certinfo example.com
```

列出证书的详细信息，包括有效期、颁发机构、加密算法等

```
openssl s_client -connect example.com:443
```

显示证书链、加密算法、证书有效期等

**域名反向查询**：查找与该IP相关的域名，通常用于信息收集

```
curl ipinfo.io/8.8.8.8
```

**HTTP响应头检查**：分析网站返回的HTTP响应头，识别安全问题和域名配置

```
curl -I https://example.com
```

返回HTTP响应头信息，如状态码、服务器信息、缓存策略等

```
http -v https://example.com
```

返回详细的HTTP响应头和内容

**DNS安全扫描工具**：检查域名的DNS安全性，包括是否启用DNSSEC

```
fierce --domain example.com
```

## 

https://blog.csdn.net/m0_46467017/article/details/126380415

# 文件包含

开发人员常常把可重复使用的函数写入单个文件，提高代码**重用性**，使用该函数时，直接调用此文件，无需再编写函数，这一过程叫做包含

**文件包含漏洞**通常出现在动态网页中。前端用户选择要包含的文件，而开发人员没有对要包含的文件进行安全考虑：对文件名没有进行合理校验，或校验被绕过，则攻击者可以修改文件位置让后台包含任意文件，导致文件包含漏洞

![image-20251105173250038](D:\PROJECT\MDProject\inject\文件包含.assets\image-20251105173250038.png)

PHP中常见的文件包含函数：

- include():找不到被包含的文件时*只产生警告*，脚本继续运行，有返回值
- include_once():类似include,但是如果该文件中代码已经被包含，则不会再次包含
- require():找不到被包含的文件产生致命错误，*停止运行*，无返回值
- require_once():只包含一次

- 读取文件highlight_file,show_source,readfile,file_get_contents,fopen,file

特性：

- 若文件内容符合PHP语法规范，包含时不管扩展名是什么都会被解析
- 若文件内容不符合PH语法规范则会暴露源码

**文件包含分类**

主要分为本地LFI和远程，取决于所包含文件位置的不同

### LFI

```php
<?php
	$file=$_GET['filename'];
	include($file);
?>
```

- 使用绝对路径读取

  - ```
    ?filename=C:\Windows\System.ini
    ```

- 相对路径

  - ```
    ../../Windows/System.ini
    ```

- 常见敏感目录信息

  ```
  C:\boot.ini //查看系统版本
  C:\windows\system32\inetsrv\MetaBase.xml //IIS配置文件
  C:\windows\repair\sam //存储Windows系统初次安装的密码
  C:\ProgramFiles\mysql\my.ini //Mysql配置
  C:\ProgramFiles\mysql\data\mysql\user.MYD //MySQL root密码
  C:\windows\php.ini //php配置信息
  
  /etc/password //账户信息
  /etc/shadow //账户密码信息
  /usr/local/app/apache2/conf/httpd.conf //Apache2默认配置文件
  /usr/local/app/apache2/conf/extra/httpd-vhost.conf //虚拟网站配置
  /usr/local/app/php5/lib/php.ini //PHP相关配置
  /etc/httpd/conf/httpd.conf //Apache配置文件
  /etc/my.conf //mysql配置文件
  ```

利用方式

- 配合文件上传使用：找不到文件漏洞，无法上传webshell,可以先上传一个图片格式的webshell，再利用本地文件包含漏洞解析

### RFI

- allow_url_fopen:为ON时，能读取远程文件
- allow_url_include:为ON时，可包含远程文件

### 伪协议

**file://**：读取文件,对allow_url_fopen和allow_url_include无要求

```
?file=file://D:/tools/phpStudy/WWW/text1.txt
```

**php://filter**读取源代码并进行base64编码输出

```
?file=php://filter/read=convert.base64-encode-encode/resource=./index.php
```

**php://input**：访问原始数据的只读流，将POST请求的数据当作php代码执行；include为on

```
?file=php://input [POST DATA] <?php phpinfo()?>
```

**data://**用户控制输入流，与包含函数结合，用户输入被当作php文件执行

# 文件上传

原因：

- 对上传文件后缀名没有做严格限制

- 对文件MIMETYPE没有做检查
- 权限上没有对于上传的文件目录设置不可执行权限
- 对web server上传文件或指定目录的行为未做限制

原理：

在WEB中进行文件上传的原理是将表单设置为multipart/form-data,同时加入文件域，而后通过HTTP协议将文件内容发送到服务器，服务器读取这个分段的数据信息并将其中的文件内容提取出来并保存

通常，服务器端读取文件原始文件名，并从中得到文件扩展名，之后随机为文件取一个文件名，并加上扩展名保存到服务器

## 绕过

- 黑名单，白名单

判断前后端可以通过抓包，如果上传后没有抓到包，说明并没有经过服务器，证明是前端。

- 在浏览器设置中禁用JavaScript上传非法文件，随后抓包中修改文件后缀名，再上传

- 对调用事件处的返回值进行修改

- 修改Content-Type

- 在httpd.conf（服务器全局，Apache的主配置文件，管理员才有权限修改，且需要重启服务器生效）文件中修改，包含服务器全局行为和默认设置

  - ```
    // 取消注释
    AddType application/x-httpd-php .php 加上 .php3 .php5 phtml等
    // 表示可悲解析为php文件的后缀名
    ```

- 修改php版本，nts表示非多线程安全的

- .htaccess分布式配置文件，位于网站根目录或特定目录（可以直接修改，即时生效），只影响该目录及其子目录，每个目录都有自己的.htaccess文件；一般用于URL重写，认证，访问控制等

  - ```
    开启配置权限AllowOverride ALL //允许.htaccess文件覆盖任何配置选项（此时优先级啊高于httpd-conf）
    写入AddType application/x-httpd-php .jpg .txt等
    ```

- 图片木马与图片一起上传

  - ```
    terminal
    copy webshell.php + 1.jpg/b 2.jpg
    将木马文件webshell.php与图片1.jpg(以二进制形式)合并成2.jpg上传
    ```

- user.ini

  - 前提：.user.ini可以生效并且该上传目录含有php文件

  - ```
    Auto-prepend-file = 1.txt //自动包含文件，即在运行所有php代码之前，都要包含该文件仅有的php代码
    //举例
    目录中有文件A.php：echo "hello"
    文件b.txt:echo "world"
    Auto-prepend-file = b.txt //输出hello world
    ```

- php.ini存储对整个php环境生效的配置选项，通常位于php安装目录，作用域所有运行在php环境中的php请求，优先级较低，重启php或web服务器生效

  - ```
    其中use_ini.filename = ".user.ini" //为空默认不生效
    user_ini.cache_ttl = 300 //生效时间
    ```

- 只进行一次过滤：`. .`或大写或加空格或加点

- 附加数据流Alternate Data Stream ---ADS 存储文件的元数据，备份信息，标签等，只用在访问附加数据流时才能看到其内容，隐藏，不会验证后缀，以::$DATA为后缀表示额外数据流

  - ```
    cmd写入
    echo {content} >> 文件名:自定义数据流名
    type {文件名} >> 文件名:数据流名
    查看
    notepad 文件名:数据流名
    ```

# Ping

ping指令的作用

- 检测网络连通情况和分析网络速度
- 根据域名得到服务器IP
- 根据ping返回的TTL值判断对方使用的操作系统及数据包经过路由器的数量

![image-20251025164231917](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20251025164231917.png)

- 字节就是数据包的大小；时间指响应时间；
- TTL(Time To Live)表示DNS记录在DNS服务器上存在的时间，告诉路由器该数据包合适需要被丢弃。根据TTL大小可粗略判断系统类型
  - 100-130ms：Windows
  - 240-255ms：UNIX/Linux

**ping -t**

不间断的ping指定计算机，ctrl+c中断

**ping -a**

通过ping其IP地址可以解析主机名![ping命令最全的用法与分析，收藏系列_ip地址_04](https://s2.51cto.com/images/blog/202409/09105652_66de63f42c67a66032.jpg?x-oss-process=image/watermark,size_14,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=,x-oss-process=image/resize,m_fixed,w_1184)

**ping -n**

默认发送4个数据包，该命令可定义发送个数，用于衡量网络速度

![ping命令最全的用法与分析，收藏系列_命令行_05](https://s2.51cto.com/images/blog/202409/09105652_66de63f42de2d30102.jpg?x-oss-process=image/watermark,size_14,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=,x-oss-process=image/resize,m_fixed,w_1184)

**ping -l size**

发送指定size大小到目标的数据包。

默认32字节，最大65500字节

**ping -r count**

在“记录路由字段”中记录传出和返回数据包的路由，探测经过呃路由个数，最多9个![ping命令最全的用法与分析，收藏系列_ip地址_07](https://s2.51cto.com/images/blog/202409/09105652_66de63f42e56a48707.jpg?x-oss-process=image/watermark,size_14,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=,x-oss-process=image/resize,m_fixed,w_1184)

**ping网段**

for /L %D in (1,1,255) do (ping -n (IP段).%D -n 1 && echo (IP段).%D>>ok.txt || echo (IP段).%D>>no.txt) 

检测从192.168.1.1到192.168.1.255所有IP，ping通的与不通的写入不同文件

## 执行漏洞

连接符

- A;B 先执行A，再执行B
- A&B 简单拼接，AB之间无制约关系
- A|B 显示B的执行结果
- A&&B A执行成功才会执行B
- A||B A执行失败才会执行B