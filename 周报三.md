# 周报三

本周系统学习文件上传及文件包含相关漏洞及利用，实战upload-labs,dvwa等靶场以及XCTF相关题目，了解NEFS权限，文件共享，VPN,并进行了DHCP部署,DNS部署，IIS WEB,FTP服务器搭建等

# 文件共享实验

实验设备：win-xp，win2003

CIFS文件共享

- 首先配置xp与2003的ip为10.0.0.1（255.255.255.0）和10.0.0.2（255.255.255.0）

- win-2003中新建文件夹share，在其目录下再新建a,b,c文件夹![image-20260202110135890](D:\PROJECT\MDProject\report\周报三.assets\image-20260202110135890.png)

- 右击文件夹share，点击属性。在属性中选择共享栏，并点击“共享此文件夹”，填写共享名（并非指文件名share，而是共享后对方看到的名字，可以自命名）。点击权限，设置Everyone的权限问完全控制![image-20260202110519754](D:\PROJECT\MDProject\report\周报三.assets\image-20260202110519754.png)

- 创建共享后图标变化如下![image-20260202111003151](D:\PROJECT\MDProject\report\周报三.assets\image-20260202111003151.png)

- 在2003中新建用户a（避免泄露管理员信息）![image-20260202112429607](D:\PROJECT\MDProject\report\周报三.assets\image-20260202112429607.png)
- 在xp中访问网络地址10.1.1.2![image-20260202111445317](D:\PROJECT\MDProject\report\周报三.assets\image-20260202111445317.png)

输入用户名及密码后可以查看共享文件，文件名显示为设置的共享文件名

![image-20260202112549889](D:\PROJECT\MDProject\report\周报三.assets\image-20260202112549889.png)

# DHCP部署实验

实验设备：xp 2003

准备工作，在2003上安装服务

- 设置Internet协议，2003服务器IP地址使用静态IP地址，注意地址预留给服务器。xp需要配置为自动获取IP和DNS，两台电脑均选择VMNet2模式。系统默认为VMNet1和VMNet8提供DHCP服务，可能产生影响，可以在”虚拟网络编辑器中“取消勾选“使用本地DHCP服务将IP地址分配给虚拟机”![image-20260202153428734](D:\PROJECT\MDProject\report\周报三.assets\image-20260202153428734.png)![image-20260202160334510](D:\PROJECT\MDProject\report\周报三.assets\image-20260202160334510.png)
- 点击光盘，选择“安装可选的组件”

![image-20260202152651521](D:\PROJECT\MDProject\report\周报三.assets\image-20260202152651521.png)

双击应用服务，勾选“DHCP”

![image-20260202153117860](D:\PROJECT\MDProject\report\周报三.assets\image-20260202153117860.png)

可以看到本机端口中包含DHCP服务的端口

![image-20260202153914035](D:\PROJECT\MDProject\report\周报三.assets\image-20260202153914035.png)

- 开始菜单中打开DHCP，并关闭服务（右击IP->所有任务->停止），那么67 68端口不再开放![image-20260202154727681](D:\PROJECT\MDProject\report\周报三.assets\image-20260202154727681.png)

![image-20260202154630576](D:\PROJECT\MDProject\report\周报三.assets\image-20260202154630576.png)

![image-20260202154803463](D:\PROJECT\MDProject\report\周报三.assets\image-20260202154803463.png)

- 配置作用域，预留IP。可选排除的ip，以及配置租期![image-20260202155004518](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155004518.png)![image-20260202155156022](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155156022.png)![image-20260202155139034](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155139034.png)

- 配置DHCP选项，如网关，DNS服务器![image-20260202155305978](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155305978.png)![image-20260202155406751](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155406751.png)![image-20260202155529658](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155529658.png)
- 配置成功后可以查看地址池，作用域等选项![image-20260202155818607](D:\PROJECT\MDProject\report\周报三.assets\image-20260202155818607.png)

- 在xp中操作，右键查看网络状态。注意需要重启连接，查看详细信息，即配置的DHCP信息![image-20260202160825114](D:\PROJECT\MDProject\report\周报三.assets\image-20260202160825114.png)![image-20260202161104284](D:\PROJECT\MDProject\report\周报三.assets\image-20260202161104284.png)

在租约期限内重启服务，仍会使用同一IP

# DHCP

**作用**：Dynamic Host Configuration Protocol自动分配地址

**地址池/作用域**包含IP、子网掩码、网关、DNS、租期

协议端口：UDP 67 / 68

**优点**：减少工作量、避免IP冲突（手动配置No）、提高地址利用率

**原理**：该过程也成称为DHCP**租约过程**，类比租房过程

- **发送DHCP Discovery广播包**：客户机广播请求IP地址（其中包含客户机MAC地址，唯一标识）
- **服务器响应DHCP Offer广播包**：服务器响应要提供的IP地址，并不包含子网掩码，网关等参数。（先确认IP后再提供其他信息）
- **客户机发送DHCP Request广播包**：客户机选择IP，即确认使用的IP并发送请求
- **发送DHCP ACK广播包**：服务器确定租约并提供网卡详细参数IP、掩码、网关、DNS、租期等

**DHCP续约**

租期超过50%后，客户机再次发送**DHCP Request包**，进行续约。如果服务器没有响应，则继续再87.5%（1/8）处再次发送Request包进行续约，如果仍无响应，则释放IP地址并重新发送DHCP Discovery广播包获取IP地址。当没有任何服务器响应时，自动给自己分配无效IP地址（仅限局域网内通信）为169.254.x.x/16

**部署DHCP服务器**

服务器必须使用固定IP地址->安装DHCP插件->新建作用域及其选项->激活->客户机认证

```
ipconfig /release  释放IP（触发方式有：1取消租约，2手动配置IP）
ipconfig /renew 重新获取IP（有IP时发送request续约，没有时发送Discovery重新获取IP）
```

**地址保留**：对指定MAC地址固定动态分配的IP地址

**选项优先级**：作用域选项>服务器选项。当服务器包含多个作用域可以直接在服务器设置选项上DNS服务器

**DHCP攻击与防御**

1）攻击DHCP服务器：频繁发送伪装DHC请求，指导将DHCP地址资源耗尽

防御：在交换机（管理型）端口上做动态MAC地址绑定

2）伪装DHCP服务器攻击：Hacker通过将自己部署为DHCP服务器，为客户机提供非法IP地址

防御：在交换机（管理型），除合法DHCP服务器所在接口外全部设置为禁止发送DHCP Offer包

# DNS

Domain Name Service域名服务，为客户机提供域名解析服务器

**域名组成**

“主机名.域名（DNS后缀）“称为完全限定域名（FQDN），一个域名下可以有多个主机，域名全球唯一。

一般管理员在命名其主机时会根据主机功能命名，比如网站是www，博客是blog，论坛是bbs。以sina.com.cn为例，对应FQDN为www.sina.com.cn,blog.sina.cn,bbs.sina.com.cn，而只需要申请一个域名”sina.com.cn“即可

树形结构

![img](https://i-blog.csdnimg.cn/blog_migrate/290b93fb18772a1439370a9364a627c7.png)

监听端口：TCP53 UDP53

**DNS解析种类**

- 按查询方式分类

```
1）递归查询：客户机与本地DNS服务器之间
2）迭代查询：本地DNS服务器与根等其他DNS服务器的系欸西过程
```

![img](https://pic3.zhimg.com/v2-a36a1fc74bf1576c856ba65b6c29f8ae_1440w.jpg)

- 按查询内容分类

正向解析：域名->IP；反向解析

# NTFS权限

https://blog.csdn.net/weixin_58376680/article/details/134659012

**概述**

设置NTFS权限实现不同用户访问不同权限，防止资源被篡改，删除。只有分配正确的访问权限后，用户才能访问资源

windows:FAT12 FAT32 NTFS EXFAT

Linux:EXT2 EXT3 EXT4 XFS	

在外部存储设备上组织文件的方法称为**文件系统**，NTFS文件系统有以下特点：

- 提高磁盘读写性能
- 可靠性：加密文件系统EFS，访问控制列表ACL
- 磁盘利用率，压缩，磁盘配额
- 支持单个文件大于4G

# VPN

虚拟专用网络Virtual Private Network

VPN在不安全的网络上，安全的传输数据，好像专网

VPN只是一个技术，使用PKI，来保证数据的安全的三要素

安全三要素：机密性，完整性，身份验证

**VPN类型**

1）远程访问VPN（Remote Access VPN）

一般用在个人到安全连接企业内部

一般出差员工/在家办公，安全连接内网时使用

一般公司部署VPN服务器，员工在外拨号连接VPN即可

常见RA－VPN协议：PPPTP、L2TP VPN、SSTP VPN

EZvpn/easyvpn、SSL VPN

2）点到点VPN

一般用在企业对企业安全连接！

一般需要在两个企业总出口设备之间建立VPN通道

常见的点到点VPN：IPsecVPN

**IPsecVPN **

1）作用：属于点到点VPN，可以在2家企业之间建立VPN隧道

2）VPN隧道优点：安全性！

 合并两家企业内网！

3）VPN隧道技术：

- 传输模式：只加密上层数据，不加密私有IP包头，速度相对快

隧道模式：加密整个私有IP包，包括IP包头，更安全，速度相对慢

- VPN隧道技术：重新封装技术+加密认证技术

```
show crypto isakmp sa 查看第一阶段状态

show crypto ipsec sa  查看第二阶段状态

show crypto isakmp policy 查看第一阶段的策略配置集
```

# 文件包含

开发人员常常把可重复使用的函数写入单个文件，提高代码**重用性**，使用该函数时，直接调用此文件，无需再编写函数，这一过程叫做包含

**文件包含漏洞**通常出现在动态网页中。前端用户选择要包含的文件，而开发人员没有对要包含的文件进行安全考虑：对文件名没有进行合理校验，或校验被绕过，则攻击者可以修改文件位置让后台包含任意文件，导致文件包含漏洞

![image-20251105173250038](D:\PROJECT\MDProject\report\周报三.assets\image-20251105173250038.png)

PHP中常见的文件包含函数：

- include():找不到被包含的文件时*只产生警告*，脚本继续运行，有返回值
- include_once():类似include,但是如果该文件中代码已经被包含，则不会再次包含
- require():找不到被包含的文件产生致命错误，*停止运行*，无返回值
- require_once():只包含一次

- 读取文件highlight_file,show_source,readfile,file_get_contents,fopen,file

特性：

- 若文件内容符合PHP语法规范，包含时不管扩展名是什么都会被解析
- 若文件内容不符合PH语法规范则会暴露源码

**文件包含分类**

主要分为本地LFI和远程，取决于所包含文件位置的不同

LFI

**源码**

```php
<?php
	$file=$_GET['filename'];
	include($file); // 或include_once,require,require_once
?>
```

**利用条件**：php.ini中allow_url_fopen=On(默认开启)，用户参数可控且后台代码没有对包含的文件进行过滤

**利用方式**：

- 绝对/相对路径读取

- ```
  ?filename=C:\Windows\System.ini
  ../../Windows/System.ini
  ```

- 常见敏感目录信息

  ```
  C:\boot.ini //查看系统版本
  C:\windows\system32\inetsrv\MetaBase.xml //IIS配置文件
  C:\windows\repair\sam //存储Windows系统初次安装的密码
  C:\ProgramFiles\mysql\my.ini //Mysql配置
  C:\ProgramFiles\mysql\data\mysql\user.MYD //MySQL root密码
  C:\windows\php.ini //php配置信息
  
  /etc/password //账户信息
  /etc/shadow //账户密码信息
  /usr/local/app/apache2/conf/httpd.conf //Apache2默认配置文件
  /usr/local/app/apache2/conf/extra/httpd-vhost.conf //虚拟网站配置
  /usr/local/app/php5/lib/php.ini //PHP相关配置
  /etc/httpd/conf/httpd.conf //Apache配置文件
  /etc/my.conf //mysql配置文件
  ```

RFI

**利用条件**：allow_url_fopen=ON（默认开启）和allow_url_include=ON（默认关闭）开启，用户参数可控且后台代码没有对包含的文件进行过滤

**利用文件包含写木马**

伪协议

**file://**：读取文件,对allow_url_fopen和allow_url_include无要求

```
?file=file://D:/tools/phpStudy/WWW/text1.txt
```

**php://filter**读取源代码并进行base64编码输出

```
?file=php://filter/read=convert.base64-encode-/resource=./index.php
```

**php://input**：访问原始数据的只读流，将POST请求的数据当作php代码执行；include为on

```
?file=php://input [POST DATA] <?php phpinfo()?>
```

**data://**用户控制输入流，与包含函数结合，用户输入被当作php文件执行

# 文件上传

原因：

- 对上传文件后缀名没有做严格限制

- 对文件MIMETYPE没有做检查
- 权限上没有对于上传的文件目录设置不可执行权限
- 对web server上传文件或指定目录的行为未做限制

原理：

在WEB中进行文件上传的原理是将表单设置为multipart/form-data,同时加入文件域，而后通过HTTP协议将文件内容发送到服务器，服务器读取这个分段的数据信息并将其中的文件内容提取出来并保存

通常，服务器端读取文件原始文件名，并从中得到文件扩展名，之后随机为文件取一个文件名，并加上扩展名保存到服务器

绕过

- 黑名单，白名单

判断前后端可以通过抓包，如果上传后没有抓到包，说明并没有经过服务器，证明是前端。

- 在浏览器设置中禁用JavaScript上传非法文件，随后抓包中修改文件后缀名，再上传

- 对调用事件处的返回值进行修改

- 修改Content-Type

- 在httpd.conf（服务器全局，Apache的主配置文件，管理员才有权限修改，且需要重启服务器生效）文件中修改，包含服务器全局行为和默认设置

  - ```
    // 取消注释
    AddType application/x-httpd-php .php 加上 .php3 .php5 phtml等
    // 表示可悲解析为php文件的后缀名
    ```

- 修改php版本，nts表示非多线程安全的

- .htaccess分布式配置文件，位于网站根目录或特定目录（可以直接修改，即时生效），只影响该目录及其子目录，每个目录都有自己的.htaccess文件；一般用于URL重写，认证，访问控制等

  - ```
    开启配置权限AllowOverride ALL //允许.htaccess文件覆盖任何配置选项（此时优先级啊高于httpd-conf）
    写入AddType application/x-httpd-php .jpg .txt等
    ```

- 图片木马与图片一起上传

  - ```
    terminal
    copy webshell.php + 1.jpg/b 2.jpg
    将木马文件webshell.php与图片1.jpg(以二进制形式)合并成2.jpg上传
    ```

- user.ini

  - 前提：.user.ini可以生效并且该上传目录含有php文件

  - ```
    Auto-prepend-file = 1.txt //自动包含文件，即在运行所有php代码之前，都要包含该文件仅有的php代码
    //举例
    目录中有文件A.php：echo "hello"
    文件b.txt:echo "world"
    Auto-prepend-file = b.txt //输出hello world
    ```

- php.ini存储对整个php环境生效的配置选项，通常位于php安装目录，作用域所有运行在php环境中的php请求，优先级较低，重启php或web服务器生效

  - ```
    其中use_ini.filename = ".user.ini" //为空默认不生效
    user_ini.cache_ttl = 300 //生效时间
    ```

- 只进行一次过滤：`. .`或大写或加空格或加点

- 附加数据流Alternate Data Stream ---ADS 存储文件的元数据，备份信息，标签等，只用在访问附加数据流时才能看到其内容，隐藏，不会验证后缀，以::$DATA为后缀表示额外数据流

